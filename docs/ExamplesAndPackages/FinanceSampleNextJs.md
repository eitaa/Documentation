
# نمونه برنامه مدیریت مالی با Next.js

این پروژه با هدف آموزش و نمایش قابلیت‌های مینی‌اپ در پیام‌رسان ایتا برای کاربران و توسعه‌دهندگان طراحی شده است. در این مستند، ساختار پروژه، نحوه اینتگریت کردن مینی‌اپ با ایتا و نکات کلیدی برای توسعه‌دهندگان و کاربران به طور کامل توضیح داده می‌شود.

---

## معرفی کلی

BaHesabSho یک مینی‌اپ برای مدیریت هزینه‌ها است که به صورت یک وب‌اپلیکیشن React/Next.js پیاده‌سازی شده و قابلیت اجرا به عنوان مینی‌اپ در محیط ایتا را دارد. این پروژه به شما نشان می‌دهد چگونه می‌توانید اپلیکیشن خود را با API و امکانات مینی‌اپ ایتا یکپارچه کنید.

---

## ساختار پروژه

ساختار پوشه‌ها و فایل‌های اصلی پروژه به شرح زیر است:

- **app/**: شامل صفحات اصلی و layout پروژه است.
  - `page.tsx`: صفحه اصلی که منطق تشخیص مینی‌اپ و مدیریت ورود کاربر را دارد.
  - `dashboard/`: صفحات داشبورد و مدیریت هزینه‌ها.
- **components/**: کامپوننت‌های قابل استفاده مجدد مانند فرم ثبت شماره، لیست هزینه‌ها و ...
- **context/**: مدیریت state سراسری پروژه (پروفایل، نوع ورود، وضعیت اینترنت و ...)
- **hooks/**: هوک‌های سفارشی برای مدیریت fetch، نشست کاربر و ...
- **public/scripts/**: اسکریپت eitaa-web-app.js برای ارتباط با API مینی‌اپ ایتا.
- **utils/**: ابزارها و توابع کمکی مانند انتخابگر پیام‌رسان.
- **types/**: تعریف تایپ‌های TypeScript برای داده‌ها.

---

## نحوه اینتگریت کردن مینی‌اپ با ایتا

### ۱. بارگذاری اسکریپت ایتا
در فایل `app/layout.tsx`، اسکریپت `eitaa-web-app.js` قبل از بارگذاری صفحات اضافه شده است:

```tsx title="tsx"
<Script src="/scripts/eitaa-web-app.js" strategy="beforeInteractive" />
```

این اسکریپت امکانات ارتباط با محیط مینی‌اپ ایتا را فراهم می‌کند.

### ۲. تشخیص اجرا در محیط مینی‌اپ
در صفحه اصلی (`app/page.tsx`) با استفاده از آبجکت `Messenger` (که window.Eitaa را برمی‌گرداند) بررسی می‌شود که آیا اپ در محیط مینی‌اپ اجرا می‌شود یا خیر:

```tsx title="tsx"
updateIsMiniApp(
  Messenger()?.WebApp?.initData !== "" &&
  Messenger()?.WebApp?.initData !== undefined
);
```

### ۳. دریافت اطلاعات کاربر از ایتا
اگر اپ در محیط مینی‌اپ اجرا شود، اطلاعات کاربر از طریق `Messenger().WebApp.initDataUnsafe.user` دریافت می‌شود و کاربر به داشبورد هدایت می‌شود:

```tsx title="tsx"
if (Messenger()?.WebApp?.initDataUnsafe.user) {
  router.replace("/dashboard/home");
}
```

### ۴. ارسال داده به سرور برای اعتبارسنجی
برای اعتبارسنجی داده‌های دریافتی از ایتا، داده‌ها به سرور ارسال می‌شود:

```tsx title="tsx"
const sendMessengerData = async (initData: string) => {
  const response = await fetchData(
    `${process.env.mainURL}/verify-initdata-Bahesabsho`,
    {
      headers: {
        EitaaInitData: encodeUserInfo(initData),
      },
      method: "POST",
    }
  );
  if (response.statusCode === 200) {
    localStorage.setItem("userInit", response.data.id);
  }
};
```

### ۵. مدیریت رویدادها و امکانات مینی‌اپ
اسکریپت ایتا امکاناتی مانند گسترش صفحه، آماده‌سازی، تایید بستن و مدیریت swipe را فراهم می‌کند:

```tsx title="tsx"
Messenger().WebApp.expand();
Messenger().WebApp.ready();
Messenger().WebApp.enableClosingConfirmation();
Messenger().WebView.postEvent("web_app_setup_swipe_behavior", () => {}, {
  allow_vertical_swipe: false,
});
```

### ۶. دریافت شماره تماس کاربر
در صورت نیاز به دریافت شماره تماس کاربر، رویداد `contactRequested` مدیریت می‌شود و شماره به سرور ارسال می‌گردد:

```tsx title="tsx"
Messenger()?.WebApp.offEvent("contactRequested", function (contact) {
  sendMessengerPhone(contact);
});
```

### ۷. مدیریت وضعیت ورود و پروفایل
در صورتی که اپ خارج از محیط مینی‌اپ اجرا شود، کاربر باید شماره موبایل خود را وارد کند و OTP دریافت نماید. این منطق در کامپوننت `RegisterPhone` پیاده‌سازی شده است.

---

## مثال عملی: تشخیص و مدیریت مینی‌اپ
در صفحه اصلی پروژه، ابتدا بررسی می‌شود که آیا اپ در محیط مینی‌اپ ایتا اجرا می‌شود یا خیر. اگر بله، اطلاعات کاربر از ایتا گرفته و به داشبورد هدایت می‌شود. اگر نه، کاربر باید شماره موبایل خود را وارد کند و پس از تایید OTP وارد داشبورد می‌شود.

---

## مدیریت داده‌ها و context
پروژه از context برای مدیریت داده‌های سراسری استفاده می‌کند:
- **LoginTypeContext**: تشخیص اجرا در مینی‌اپ
- **ProfileContext**: مدیریت اطلاعات پروفایل کاربر
- **NoNetContext**: مدیریت وضعیت اینترنت
- **CostContext**: مدیریت لیست هزینه‌ها
- **ThemeContext**: مدیریت تم روشن/تاریک

---

## نمایش و مدیریت هزینه‌ها
در داشبورد، لیست هزینه‌ها با توجه به نوع ورود (مینی‌اپ یا معمولی) از سرور دریافت و نمایش داده می‌شود. اگر کاربر از طریق مینی‌اپ وارد شده باشد، شناسه کاربری از داده‌های ایتا استفاده می‌شود:

```tsx title="tsx"
const response = await fetchData(
  `${process.env.mainURL}/get-all-costs?${
    isMiniApp ? `UserId=${userInit?.id}` : `PhoneNumber=${phoneNumber}`
  }`
);
```

---

## وابستگی‌ها و تکنولوژی‌ها
- React 18
- Next.js 14
- TypeScript
- TailwindCSS
- Context API

---

## جمع‌بندی و نکات مهم برای توسعه‌دهندگان
- برای اینتگریت کردن اپ خود با مینی‌اپ ایتا، باید اسکریپت eitaa-web-app.js را بارگذاری و از APIهای آن استفاده کنید.
- اطلاعات کاربر و وضعیت اجرا را با استفاده از window.Eitaa.WebApp مدیریت کنید.
- برای اعتبارسنجی داده‌ها، اطلاعات دریافتی از ایتا را به سرور ارسال کنید.
- مدیریت state سراسری با context انجام می‌شود و توسعه اپلیکیشن را ساده‌تر می‌کند.
- مثال‌های عملی در فایل‌های `app/page.tsx` و `app/dashboard/layout.tsx` قابل مشاهده است.

---

## سوالات متداول

**چگونه بفهمم اپ من در محیط مینی‌اپ ایتا اجرا می‌شود؟**

با بررسی مقدار `window.Eitaa.WebApp.initData` می‌توانید این موضوع را تشخیص دهید.

**چگونه اطلاعات کاربر را از ایتا دریافت کنم؟**

از آبجکت `window.Eitaa.WebApp.initDataUnsafe.user` استفاده کنید.

**آیا می‌توانم اپ خود را هم به صورت مستقل و هم به صورت مینی‌اپ اجرا کنم؟**

بله، ساختار پروژه به گونه‌ای است که هر دو حالت را پشتیبانی می‌کند.

---

برای اطلاعات بیشتر و مثال‌های دقیق‌تر، کدهای موجود در پوشه app و components را بررسی کنید. 