# نمونه برنامه ToDo با Next.js

این پروژه برای نمایش و آموزش قابلیت‌های **مینی‌اپ** در پیام‌رسان ایتا طراحی شده است. هدف این پروژه، کمک به توسعه‌دهندگان و کاربران برای درک نحوه‌ی یکپارچه‌سازی اپلیکیشن‌های خود با امکانات مینی‌اپ ایتا و پیاده‌سازی سناریوهای رایج است.

---

## مقدمه

مینی‌اپ‌ها اپلیکیشن‌هایی هستند که در بستر پیام‌رسان‌ها (مانند ایتا) اجرا می‌شوند و می‌توانند با API پیام‌رسان تعامل داشته باشند. این پروژه یک نمونه‌ی کامل از یک مینی‌اپ است که با Next.js و TypeScript توسعه یافته و قابلیت اجرا به صورت وب‌اپ مستقل و مینی‌اپ داخل ایتا را دارد.

---

## ساختار پروژه

- **app/page.tsx**  
  نقطه ورود اصلی پروژه است. این فایل تشخیص می‌دهد که آیا اپلیکیشن در حالت مینی‌اپ اجرا می‌شود یا خیر و بر اساس آن رفتار متفاوتی نشان می‌دهد (مانند فراخوانی APIهای ایتا، مدیریت مسیرها و ...).

- **components/RegisterPhone.tsx**  
  کامپوننت ثبت شماره موبایل و ورود کاربر. این بخش هم در حالت وب و هم مینی‌اپ قابل استفاده است و با توجه به وضعیت، کاربر را به داشبورد هدایت می‌کند.

- **utils/messenger-selector.tsx**  
  ابزاری برای تشخیص محیط اجرا (آیا اپ در ایتا اجرا می‌شود یا خیر) و دسترسی به APIهای پیام‌رسان.

- **context/LoginTypeContext.tsx**  
  مدیریت وضعیت اجرا (مینی‌اپ یا وب) در کل برنامه با استفاده از React Context.

- **context/ProfileContext.tsx**  
  مدیریت اطلاعات پروفایل کاربر.

- **hooks/useManageSession.tsx**  
  هوک سفارشی برای مدیریت نشست کاربر و دریافت اطلاعات پروفایل از سرور.

- **app/dashboard/home/page.tsx**  
  صفحه اصلی پس از ورود کاربر که لیست کارها (TodoList) را نمایش می‌دهد.

- **app/dashboard/profile/page.tsx**  
  صفحه پروفایل کاربر که اطلاعات کاربر را (بسته به حالت مینی‌اپ یا وب) نمایش می‌دهد.

---

## نحوه تشخیص و یکپارچه‌سازی با مینی‌اپ ایتا

### تشخیص محیط مینی‌اپ

در فایل `utils/messenger-selector.tsx`، یک تابع ساده وجود دارد که بررسی می‌کند آیا شیء `window.Eitaa` در دسترس است یا خیر. اگر این شیء وجود داشته باشد، اپلیکیشن در محیط مینی‌اپ ایتا اجرا می‌شود:

```ts title="ts" 
const Messenger = () => {
    const Messenger = window.Eitaa;
    return Messenger;
};
export default Messenger;
```

### استفاده در نقطه ورود (app/page.tsx)

در ابتدای اجرای برنامه، با استفاده از این تابع، وضعیت اجرا بررسی می‌شود و مقدار آن در Context ذخیره می‌شود:

```ts title="ts"
useEffect(() => {
  updateIsMiniApp(
    Messenger()?.WebApp?.initData !== "" &&
    Messenger()?.WebApp?.initData !== undefined
  );
  // ...
}, []);
```

### تعامل با APIهای ایتا

در صورت اجرا به عنوان مینی‌اپ، می‌توانید از APIهای ایتا مانند `WebApp.expand()`, `WebApp.ready()`, `WebApp.enableClosingConfirmation()` و ... استفاده کنید:

```ts title="ts"
if (Messenger()?.WebApp.initData !== "" && Messenger()?.WebApp.initData !== undefined) {
  Messenger().WebApp.expand();
  Messenger().WebApp.ready();
  Messenger().WebApp.enableClosingConfirmation();
  // ...
}
```

همچنین برای ارسال داده به سرور با اطلاعات کاربر ایتا:

```ts title="ts"
const sendMessengerData = async (initData: string) => {
  const response = await fetchData(
    `${process.env.mainURL}/verify-initdata-listshow`,
    {
      headers: {
        EitaaInitData: encodeUserInfo(initData),
      },
      method: "POST",
    }
  );
  // ...
};
```

### دریافت شماره تماس کاربر از ایتا

در صورت نیاز به دریافت شماره تماس کاربر از طریق API ایتا، می‌توانید از eventهای ایتا استفاده کنید و داده را به سرور ارسال کنید:

```ts title="ts"
const sendMessengerPhone = async (contact: any) => {
  // decode and send phone number to server
};
```

### مدیریت پروفایل و نشست کاربر

در حالت مینی‌اپ، اطلاعات کاربر از طریق initData ایتا دریافت و ذخیره می‌شود و در حالت وب از طریق شماره موبایل:

```ts title="ts"
const getProfile = useCallback(async () => {
  const response = await fetchData(
    `${process.env.mainURL}/get-profile?${isMiniApp ? `UserId=${userInit?.id}` : `PhoneNumber=${phoneNumber}`}`
  );
  // ...
}, [error]);
```

---

## مثال: ثبت نام و ورود کاربر

- کاربر وارد اپ می‌شود.
- اگر در محیط مینی‌اپ باشد، اطلاعات کاربر از ایتا گرفته می‌شود و به سرور ارسال می‌شود.
- اگر در محیط وب باشد، کاربر باید شماره موبایل خود را وارد کند و کد تایید دریافت کند.
- پس از تایید، کاربر به داشبورد هدایت می‌شود.

---

## نکات مهم برای توسعه‌دهندگان

- همیشه محیط اجرا را با استفاده از `window.Eitaa` یا توابع مشابه بررسی کنید.
- برای تعامل با APIهای ایتا، مستندات رسمی ایتا را مطالعه کنید.
- داده‌های حساس (مانند initData) را رمزنگاری و امن ارسال کنید.
- از Context برای مدیریت وضعیت اجرا (مینی‌اپ یا وب) استفاده کنید تا در کل برنامه قابل دسترسی باشد.
- برای تست حالت مینی‌اپ، می‌توانید پروژه را در محیط ایتا بارگذاری و تست کنید.

---

## جمع‌بندی

این پروژه یک نمونه‌ی کامل و قابل توسعه برای ساخت مینی‌اپ در ایتا است. با مطالعه و توسعه این پروژه، می‌توانید اپلیکیشن خود را به راحتی با قابلیت‌های مینی‌اپ ایتا یکپارچه کنید و تجربه کاربری بهتری برای کاربران پیام‌رسان فراهم آورید.

---

**در صورت نیاز به توضیحات بیشتر یا مثال‌های کد، بخش‌های خاصی از پروژه را اعلام کنید تا توضیح دهم.** 